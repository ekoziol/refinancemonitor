{% extends "main_layout.jinja2" %}

{% block pagecontent %}
<b><h1 class="text-4xl text-center text-gray-800">Manage Mortgages and Alerts</h1></b>

<table class="ml-72 mt-16">

{% for ma in mortgage_alerts %}
    {% set m = ma[0] %}
    {% set a = ma[1] %}
    {% set status_graph = ma[2] %}
    {% set time_graph = ma[3] %}

    <tr>
        <td>
        <div class="bg-gradient-to-r flex-auto w-42 h-42 from-gray-800 to-gray-700 shadow-lg rounded-lg">
        <div class="md:p-7 p-4">
        <table >
          <tr class="text-md">
            <td class="text-gray-400"><b>Mortgage Name: </b></td><td class="text-gray-200">{{ m.name }}</td>
          </tr>

          <tr class="">
            <td class="text-gray-400"><b>Original Principal:  </b></td><td class="text-gray-200">{{ "${:,.0f}".format(m.original_principal) }}</td>
          </tr>
          <tr class="">
            <td class="text-gray-400"><b>Original Interest Rate: </b></td><td class="text-gray-200">{{ m.original_interest_rate*100 }}%</td>
          </tr>
          <tr class="">
            <td class="text-gray-400"><b>Original Term: </b></td><td class="text-gray-200">{{ m.original_term }}</td>
          </tr>
          <tr class="">
            <td class="text-gray-400"><b>Remaining Principal: </b></td><td class="text-gray-200">{{ "${:,.0f}".format(m.remaining_principal) }}</td>
          </tr>
          <tr class="">
            <td class="text-gray-400"><b>Remaining Term: </b></td><td class="text-gray-200">{{ m.remaining_term }}</td>
          </tr>
          
        </table>
        <br/>
        <a href="{{url_for('mortgage_bp.editmortgage', m_id=m.id)}}" class="float-right text-green-600">Modify</a>
        </div>
        </div>
        </td>


        {% if a is not none %}
        <td class="">
          <div class="bg-gradient-to-r flex-auto w-42 h-42 from-gray-800 to-gray-700 shadow-lg rounded-lg">
            <div class="md:p-7 p-4">
          <!-- Status Badge -->
          {% set status = a.get_status() %}
          <div class="mb-3">
            {% if status == 'active' %}
            <span class="px-3 py-1 text-xs font-medium tracking-wide text-green-800 bg-green-100 rounded-full">● Active</span>
            {% elif status == 'waiting' %}
            <span class="px-3 py-1 text-xs font-medium tracking-wide text-yellow-800 bg-yellow-100 rounded-full">◐ Waiting</span>
            {% elif status == 'triggered' %}
            <span class="px-3 py-1 text-xs font-medium tracking-wide text-orange-800 bg-orange-100 rounded-full">⚡ Triggered</span>
            {% elif status == 'paused' %}
            <span class="px-3 py-1 text-xs font-medium tracking-wide text-red-800 bg-red-100 rounded-full">⏸ Paused</span>
            {% endif %}
          </div>
          <table class="">
          <tr class="">
            <td class="text-gray-400"><b>Alert Type: </b></td><td class="text-gray-200">{{ a.alert_type }}</td>
          </tr>
          {% if a.alert_type == "Monthly Payment" %}
          <tr class="">
            <td class="text-gray-400"><b>Target Monthly Payment: </b></td>
            <td class="text-gray-200">
              <span class="threshold-display" data-alert-id="{{ a.id }}" data-alert-type="Monthly Payment" data-value="{{ a.target_monthly_payment }}">
                <span class="threshold-value">${{ a.target_monthly_payment }}</span>
                <button type="button" class="threshold-edit-btn ml-2 text-blue-400 hover:text-blue-300 text-xs" title="Edit threshold">
                  <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
              </span>
              <span class="threshold-edit hidden">
                <input type="number" step="0.01" class="threshold-input w-24 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-gray-200" value="{{ a.target_monthly_payment }}">
                <button type="button" class="threshold-save-btn ml-1 text-green-400 hover:text-green-300 text-xs" title="Save">
                  <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
                <button type="button" class="threshold-cancel-btn ml-1 text-red-400 hover:text-red-300 text-xs" title="Cancel">
                  <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </span>
            </td>
          </tr>
          {% elif a.alert_type == "Interest Rate" -%}
          <tr class="">
            <td class="text-gray-400"><b>Target Interest Rate:  </b></td>
            <td class="text-gray-200">
              <span class="threshold-display" data-alert-id="{{ a.id }}" data-alert-type="Interest Rate" data-value="{{ a.target_interest_rate }}">
                <span class="threshold-value">{{ a.target_interest_rate }}%</span>
                <button type="button" class="threshold-edit-btn ml-2 text-blue-400 hover:text-blue-300 text-xs" title="Edit threshold">
                  <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
              </span>
              <span class="threshold-edit hidden">
                <input type="number" step="0.01" class="threshold-input w-20 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-gray-200" value="{{ a.target_interest_rate }}">
                <button type="button" class="threshold-save-btn ml-1 text-green-400 hover:text-green-300 text-xs" title="Save">
                  <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
                <button type="button" class="threshold-cancel-btn ml-1 text-red-400 hover:text-red-300 text-xs" title="Cancel">
                  <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </span>
            </td>
          </tr>
          {% endif %}
          <tr class="">
            <td class="text-gray-400"><b>Target Term: </b></td><td class="text-gray-200">{{ a.target_term }} years</td>
          </tr>
          <tr class="">
            <td class="text-gray-400"><b>Estimate Refinance Cost: </b></td><td class="text-gray-200">${{ a.estimate_refinance_cost }}</td>
          </tr>
          <tr class="">
            <td class="text-gray-400"><b>Payment Status: </b></td><td class="text-gray-200">{{ a.payment_status }}</td>
          </tr>
        </table>
        <div class="flex justify-end gap-4 mt-2">
          <a href="{{url_for('mortgage_bp.editalert', alert_id=a.id)}}" class="text-green-600 hover:text-green-400">Modify</a>
          <form action="{{url_for('mortgage_bp.delete_alert', alert_id=a.id)}}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this alert? This will cancel your subscription.');">
            <button type="submit" class="text-red-500 hover:text-red-400">Delete</button>
          </form>
        </div>
        </div>
        </div>
        </td>

        <td class="">
          <div class="bg-gradient-to-r flex-auto w-42 h-42 from-gray-800 to-gray-700 shadow-lg rounded-lg">
            <div class="md:p-7 p-4">
          <table class="">
            <tr class="">
              <td class="text-gray-400"><b>Trigger Status: </b></td><td class="text-gray-200">${{ a.target_monthly_payment }}</td>
            </tr>

            <tr class="">
              <td class="text-gray-400"><b>Last Trigger Date: </b></td><td class="text-gray-200">${{ a.target_monthly_payment }}</td>
            </tr>

            <tr class="">
              <td class="text-gray-400"><b>Estimated Trigger Interest Rate: </b></td><td class="text-gray-200">${{ a.target_monthly_payment }}</td>
            </tr> 

            <tr class="inforow triggerinforow">
              <td class="text-gray-400"><b>Estimated Refi Monthly Payment if done now: </b></td><td class="text-gray-200">${{ a.target_monthly_payment }}</td>
            </tr> 

            <tr class="">
              <td class="text-gray-400"><b>Estimated Current Principal Remaining: </b></td><td class="text-gray-200">${{ a.target_monthly_payment }}</td>
            </tr> 
          </table>
          </div>
        </div>
        </td>

        {% else %}
        <td class="alerttable addalertsection">
          <a href="{{url_for('mortgage_bp.addalert', m_id=m.id)}}">
            <div class="bg-gradient-to-r flex-auto w-42 h-42  from-green-900 to-green-800    shadow-lg    rounded-lg">
                    <div class="md:p-7 p-4">
                        <h2 class="text-xl text-center text-gray-200 capitalize">+ Click to set an alert</h2>
                        <h3 class="text-sm  text-gray-400  text-center">No Alerts Found</h3>
                    </div>
                </div>
            </a>
        </td>
    {% endif %}   
    </tr>

{% endfor %}


<tr>
    <td>
        <a href="{{url_for('mortgage_bp.addmortgage')}}">
            <div class="bg-gradient-to-r flex-auto w-42 h-42  from-green-900 to-green-800    shadow-lg    rounded-lg">
                    <div class="md:p-7 p-4">
                        <h2 class="text-xl text-center text-gray-200 capitalize">+ Click to Add a Mortgage</h2>
                        <h3 class="text-sm  text-gray-400  text-center">Setup a Mortgage to Monitor Rates</h3>
                    </div>
                </div>
        </a>
    </td>
</tr>

</table>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle edit button clicks
  document.querySelectorAll('.threshold-edit-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const container = this.closest('.threshold-display').parentElement;
      const display = container.querySelector('.threshold-display');
      const edit = container.querySelector('.threshold-edit');
      display.classList.add('hidden');
      edit.classList.remove('hidden');
      edit.querySelector('.threshold-input').focus();
    });
  });

  // Handle cancel button clicks
  document.querySelectorAll('.threshold-cancel-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const container = this.closest('td');
      const display = container.querySelector('.threshold-display');
      const edit = container.querySelector('.threshold-edit');
      const input = edit.querySelector('.threshold-input');
      // Reset to original value
      input.value = display.dataset.value;
      edit.classList.add('hidden');
      display.classList.remove('hidden');
    });
  });

  // Handle save button clicks
  document.querySelectorAll('.threshold-save-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const container = this.closest('td');
      const display = container.querySelector('.threshold-display');
      const edit = container.querySelector('.threshold-edit');
      const input = edit.querySelector('.threshold-input');
      const alertId = display.dataset.alertId;
      const alertType = display.dataset.alertType;
      const newValue = parseFloat(input.value);

      // Disable buttons during save
      const saveBtn = this;
      const cancelBtn = edit.querySelector('.threshold-cancel-btn');
      saveBtn.disabled = true;
      cancelBtn.disabled = true;

      fetch('/mortgage/api/alert/' + alertId + '/threshold', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ threshold_value: newValue })
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.status === 'success') {
          // Update the display
          const valueSpan = display.querySelector('.threshold-value');
          if (alertType === 'Monthly Payment') {
            valueSpan.textContent = '$' + newValue;
          } else {
            valueSpan.textContent = newValue + '%';
          }
          display.dataset.value = newValue;
          edit.classList.add('hidden');
          display.classList.remove('hidden');
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(function(error) {
        alert('Error saving threshold: ' + error.message);
      })
      .finally(function() {
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
      });
    });
  });

  // Handle Enter key in input
  document.querySelectorAll('.threshold-input').forEach(function(input) {
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.closest('.threshold-edit').querySelector('.threshold-save-btn').click();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        this.closest('.threshold-edit').querySelector('.threshold-cancel-btn').click();
      }
    });
  });
});
</script>
{% endblock %}