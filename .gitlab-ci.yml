# GitLab CI/CD Pipeline for refi_alert
# Includes automated code review, testing, and deployment to Railway

stages:
  - review
  - test
  - build
  - deploy-staging
  - deploy-production

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  NODE_OPTIONS: "--max-old-space-size=4096"

# Cache dependencies between jobs
.python-cache: &python-cache
  cache:
    key: "${CI_JOB_NAME}-python"
    paths:
      - .cache/pip
      - venv/

.node-cache: &node-cache
  cache:
    key: "${CI_JOB_NAME}-node"
    paths:
      - node_modules/
      - frontend/node_modules/

# Claude Code automated code review on merge requests
code-review:
  stage: review
  image: node:20-slim
  before_script:
    - npm install -g @anthropic-ai/claude-code
    - apt-get update && apt-get install -y git curl jq
  script:
    - chmod +x ./scripts/code-review.sh
    - ./scripts/code-review.sh
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true
  variables:
    GIT_DEPTH: 0

# Python tests
test-backend:
  stage: test
  image: python:3.11-slim
  <<: *python-cache
  services:
    - postgres:15
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    SQLALCHEMY_DATABASE_URI: "postgresql://test_user:test_password@postgres:5432/test_db"
    FLASK_ENV: testing
    SECRET_KEY: test-secret-key
  before_script:
    - apt-get update && apt-get install -y libpq-dev gcc
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
  script:
    - python -m pytest tests/ -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^polecat\//

# Frontend tests
test-frontend:
  stage: test
  image: node:20
  <<: *node-cache
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint
    - npm run test:run
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^polecat\//

# Build job - creates artifacts for deployment
build:
  stage: build
  image: node:20
  <<: *node-cache
  before_script:
    - npm install
    - cd frontend && npm ci
  script:
    # Build Tailwind CSS
    - cd ..
    - npm run build:css
    # Build React frontend
    - cd frontend
    - npm run build
  artifacts:
    paths:
      - refi_monitor/static/dist/
      - refi_monitor/static/react/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^polecat\//

# Deploy to staging (automatic on main)
deploy-staging:
  stage: deploy-staging
  image: node:20
  dependencies:
    - build
  before_script:
    - npm install -g @railway/cli
  script:
    - railway link --environment staging
    - railway up --detach
  environment:
    name: staging
    url: https://refi-alert-staging.up.railway.app
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  variables:
    RAILWAY_TOKEN: $RAILWAY_TOKEN

# Deploy to production (manual trigger)
deploy-production:
  stage: deploy-production
  image: node:20
  dependencies:
    - build
  before_script:
    - npm install -g @railway/cli
  script:
    - railway link --environment production
    - railway up --detach
  environment:
    name: production
    url: https://refialert.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  variables:
    RAILWAY_TOKEN: $RAILWAY_TOKEN

# Mirror to GitHub on main branch pushes
mirror-to-github:
  stage: deploy-production
  image: alpine/git:latest
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - git remote add github https://${GITHUB_TOKEN}@github.com/ekoziol/refinancemonitor.git || true
    - git push github --all --force
    - git push github --tags --force
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true
